# language setting
build_environment: Ubuntu 12.04
language: node_js
node_js: "6.1.0"

env:
  global:
    - APP_ENV=stubbed
    - APP_KEY=now-site
    - IMAGE=317367993082.dkr.ecr.ap-southeast-2.amazonaws.com/now-site
    - XUNIT_FILE=$SHIPPABLE_BUILD_DIR/shippable/testresults/result.xml # location to store test results
    - BRANCH_NAME="$(sed 's/\//-/g' <<< $BRANCH).$BUILD_NUMBER" # need to replace '/' in the branch name with '-'

build:
  cache: true
  cache_dir_list:
    - $SHIPPABLE_BUILD_DIR/src/node_modules
  ci:
    - npm set registry http://npm.digital.bauer-media.net.au
    - node --version
    - mkdir -p ./shippable/testresults ./shippable/codecoverage ./shippable/buildoutput
    - cd src
    - npm install
    - echo "module.exports={buildNumber:'$BRANCH_NAME'};" > version.js
    - cat version.js
    - npm run build
    - npm run test:ci
    - cd ..
    - if [ "$BRANCH" == "master" ]; then echo "versionName=$BRANCH_NAME" >> $JOB_STATE/now-site-img-master.env; fi
    - if [ "$BRANCH" != "master" ]; then echo "versionName=$BRANCH_NAME" >> $JOB_STATE/now-site-img-branch.env; fi
  post_ci:
    - ./src/node_modules/.bin/babel-istanbul report cobertura --dir  ./shippable/codecoverage/
    - docker --version
    - docker build -f Dockerfile.ecs -t $IMAGE:$BRANCH_NAME --label build-number=$BUILD_NUMBER .
    - docker tag $IMAGE:$BRANCH_NAME $IMAGE:latest
  push:
    - docker push $IMAGE:$BRANCH_NAME
    - docker push $IMAGE:latest

branches:
  only:
    - master
    - feature/*
    - fix/*

#Integration and Notifications
integrations:
  hub:
    - integrationName: AWS-digital-services-ECR
      type: ecr
      region: ap-southeast-2

  notifications:
    - integrationName: slack-bauerxcelmedia
      type: slack
      recipients:
        - "au-shippable"
      branches:
        only:
          - master
          - feature/*
          - fix/*
      on_success: always
      on_failure: always
